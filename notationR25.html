<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notation Continue - Multi-classes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 20px;
        }
        
        .selectors {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .selector-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .selector-group label {
            font-size: 14px;
            font-weight: 600;
        }
        
        select {
            padding: 10px 15px;
            border: 2px solid white;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            min-width: 200px;
        }
        
        select option {
            color: #2d3436;
            background: white;
        }
        
        .week-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .week-selector button {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .week-selector button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .week-selector span {
            font-size: 15px;
            font-weight: bold;
            min-width: 200px;
            text-align: center;
        }
        
        .info-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .info-bar .stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #2d3436;
        }
        
        .info-bar .stats span {
            font-weight: 600;
        }
        
        .btn-manage {
            background: #11998e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-manage:hover {
            background: #0d7a6f;
            transform: translateY(-2px);
        }
        
        .table-container {
            overflow-x: auto;
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        th {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th:first-child {
            border-top-left-radius: 10px;
            text-align: left;
            padding-left: 20px;
        }
        
        th:last-child {
            border-top-right-radius: 10px;
        }
        
        td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        td:first-child {
            text-align: left;
            font-weight: 600;
            color: #2d3436;
            padding-left: 20px;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .points-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .points-display {
            font-weight: bold;
            font-size: 16px;
            min-width: 40px;
        }
        
        .points-display.positive {
            color: #00b894;
        }
        
        .points-display.negative {
            color: #d63031;
        }
        
        .cell-button {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: #666;
        }
        
        .cell-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .cell-button.positive {
            background: #00b894;
            color: white;
            border-color: #00a383;
        }
        
        .cell-button.negative {
            background: #d63031;
            color: white;
            border-color: #c02828;
        }
        
        .total-cell {
            font-size: 20px;
            font-weight: bold;
            padding: 15px !important;
        }
        
        .total-cell.excellent {
            color: #00b894;
            background: #d5f4e6 !important;
        }
        
        .total-cell.good {
            color: #0984e3;
        }
        
        .total-cell.warning {
            color: #fdcb6e;
        }
        
        .total-cell.danger {
            color: #d63031;
            background: #ffe0e0 !important;
        }
        
        .actions {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-export {
            background: #00b894;
            color: white;
        }
        
        .btn-export:hover {
            background: #00a383;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,184,148,0.3);
        }
        
        .btn-reset {
            background: #d63031;
            color: white;
        }
        
        .btn-reset:hover {
            background: #c02828;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(214,48,49,0.3);
        }
        
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00b894;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #11998e;
            font-size: 18px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #636e72;
        }
        
        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #2d3436;
        }
        
        .empty-state p {
            font-size: 16px;
            margin-bottom: 25px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }
        
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h2 {
            color: #11998e;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .modal label {
            display: block;
            margin-bottom: 8px;
            color: #2d3436;
            font-weight: 600;
        }
        
        .modal input, .modal textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .modal textarea {
            min-height: 150px;
            font-family: inherit;
            resize: vertical;
        }
        
        .modal input:focus, .modal textarea:focus {
            outline: none;
            border-color: #11998e;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17,153,142,0.3);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #2d3436;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .student-list {
            list-style: none;
            margin: 15px 0;
        }
        
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 8px;
        }
        
        .student-item button {
            background: #d63031;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .student-item button:hover {
            background: #c02828;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="save-indicator" id="saveIndicator">‚úì Sauvegard√©</div>
    <div class="modal-overlay" id="modalOverlay"></div>
    
    <div class="modal" id="manageModal">
        <h2>üéì G√©rer les classes et √©l√®ves</h2>
        
        <label>Nom de la nouvelle classe :</label>
        <input type="text" id="newClassName" placeholder="Ex: 4√®me A, 3√®me B...">
        <button class="btn btn-primary" onclick="addClass()" style="width: 100%; margin-bottom: 30px;">‚ûï Ajouter cette classe</button>
        
        <label>√âl√®ves de la classe actuelle (un par ligne) :</label>
        <textarea id="studentsTextarea" placeholder="Entrez les pr√©noms, un par ligne&#10;Ex:&#10;Marie&#10;Lucas&#10;Emma"></textarea>
        
        <div class="modal-buttons">
            <button class="btn-secondary" onclick="closeManageModal()">Annuler</button>
            <button class="btn-primary" onclick="saveStudents()">üíæ Sauvegarder les √©l√®ves</button>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üìä Notation Continue - Syst√®me de points</h1>
            <div class="selectors">
                <div class="selector-group">
                    <label>üéì Classe :</label>
                    <select id="classSelector" onchange="changeClass()">
                        <option value="">S√©lectionnez une classe</option>
                    </select>
                </div>
                
                <div class="selector-group">
                    <label>üìÖ Semaine :</label>
                    <div class="week-selector">
                        <button onclick="changeWeek(-1)">‚óÄ</button>
                        <span id="weekDisplay"></span>
                        <button onclick="changeWeek(1)">‚ñ∂</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="info-bar">
            <div class="stats">
                <span>Base : 10/20</span> | 
                <span>üñ±Ô∏è Clic gauche : ajoute/enl√®ve selon colonne</span> | 
                <span>üñ±Ô∏è Clic droit : annule le dernier ajout</span>
            </div>
            <button class="btn-manage" onclick="openManageModal()">‚öôÔ∏è G√©rer les classes</button>
        </div>
        
        <div id="loadingDiv" class="loading">S√©lectionnez une classe pour commencer...</div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>üìù Aucun √©l√®ve dans cette classe</h3>
            <p>Cliquez sur "G√©rer les classes" pour ajouter des √©l√®ves</p>
            <button class="btn-manage" onclick="openManageModal()">‚öôÔ∏è G√©rer les classes</button>
        </div>
        
        <div id="mainContent" style="display: none;">
            <div class="table-container">
                <table id="notationTable">
                    <thead>
                        <tr>
                            <th>√âl√®ve</th>
                            <th>üëã<br>Participation<br>(+0,25)</th>
                            <th>üó£Ô∏è<br>Interro orale<br>(+0,25)</th>
                            <th>‚ùå<br>Travail non fait<br>(-1)</th>
                            <th>üìì<br>Oubli cahier<br>(-1)</th>
                            <th>üòê<br>Attitude<br>(clic G: -0,25 / clic D: +0,25)</th>
                            <th style="min-width: 100px;">üìä TOTAL /20</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <div class="actions">
                <button class="btn btn-export" onclick="exportData()">üìä Exporter cette semaine</button>
                <button class="btn btn-reset" onclick="resetWeek()">üîÑ R√©initialiser (tout √† 10/20)</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA4BpxaadwjKgiJH3rwOdk3WaJ9m5G9qqw",
            authDomain: "suivi-classe-4eme.firebaseapp.com",
            projectId: "suivi-classe-4eme",
            storageBucket: "suivi-classe-4eme.firebasestorage.app",
            messagingSenderId: "1088897454236",
            appId: "1:1088897454236:web:273a6ddf50ab9c0b605d59"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentClass = '';
        let currentWeekOffset = 0;
        let saveTimeout = null;
        let classes = [];
        let students = [];

        const categories = [
            { id: 'participation', value: 0.25, type: 'positive' },
            { id: 'interro', value: 0.25, type: 'positive' },
            { id: 'travail', value: -1, type: 'negative' },
            { id: 'cahier', value: -1, type: 'negative' },
            { id: 'attitude', value: -0.25, valueAlt: 0.25, type: 'negative' }
        ];

        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getWeekDates(offset) {
            const today = new Date();
            today.setDate(today.getDate() + (offset * 7));
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            const weekNum = getWeekNumber(monday);
            return {
                monday,
                sunday,
                weekNum,
                display: `Semaine ${weekNum}`
            };
        }

        function updateWeekDisplay() {
            const week = getWeekDates(currentWeekOffset);
            document.getElementById('weekDisplay').textContent = week.display;
        }

        function getCurrentWeekKey() {
            const week = getWeekDates(currentWeekOffset);
            return `notation_${currentClass}_week_${week.monday.getFullYear()}_${week.weekNum}`;
        }

        window.changeWeek = async function(offset) {
            if (!currentClass) return;
            await saveCurrentData();
            currentWeekOffset += offset;
            updateWeekDisplay();
            await loadWeekData();
        }

        window.changeClass = async function() {
            const selector = document.getElementById('classSelector');
            if (selector.value === currentClass) return;
            
            if (currentClass) {
                await saveCurrentData();
            }
            
            currentClass = selector.value;
            currentWeekOffset = 0;
            updateWeekDisplay();
            
            if (currentClass) {
                await loadStudents();
                await loadWeekData();
            }
        }

        async function loadClasses() {
            try {
                const docSnap = await getDoc(doc(db, 'notation', 'classes'));
                if (docSnap.exists()) {
                    classes = docSnap.data().list || [];
                } else {
                    classes = [];
                }
                
                const selector = document.getElementById('classSelector');
                selector.innerHTML = '<option value="">S√©lectionnez une classe</option>';
                classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    selector.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur chargement classes:', error);
            }
        }

        async function loadStudents() {
            if (!currentClass) return;
            
            try {
                const docSnap = await getDoc(doc(db, 'notation', `students_${currentClass}`));
                if (docSnap.exists()) {
                    students = docSnap.data().list || [];
                } else {
                    students = [];
                }
                
                if (students.length === 0) {
                    document.getElementById('loadingDiv').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'none';
                } else {
                    document.getElementById('loadingDiv').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    initTable();
                }
            } catch (error) {
                console.error('Erreur chargement √©l√®ves:', error);
            }
        }

        function initTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student}</td>
                    ${categories.map(cat => `
                        <td>
                            <div class="points-cell">
                                <div class="points-display ${cat.type}" data-student="${student}" data-category="${cat.id}">0</div>
                                <button class="cell-button ${cat.type}" 
                                        data-student="${student}" 
                                        data-category="${cat.id}"
                                        onclick="addPoint(this)">
                                    +
                                </button>
                            </div>
                        </td>
                    `).join('')}
                    <td class="total-cell" data-student="${student}">10</td>
                `;
                tbody.appendChild(row);
            });
        }

        window.addPoint = function(button) {
            const student = button.dataset.student;
            const categoryId = button.dataset.category;
            const category = categories.find(c => c.id === categoryId);
            
            const display = document.querySelector(`[data-student="${student}"][data-category="${categoryId}"].points-display`);
            let currentValue = parseFloat(display.textContent);
            currentValue += category.value;
            display.textContent = currentValue.toFixed(2);
            
            updateTotal(student);
            debounceSave();
            showSaveIndicator();
        }
        
        window.removePoint = function(button, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const student = button.dataset.student;
            const categoryId = button.dataset.category;
            const category = categories.find(c => c.id === categoryId);
            
            const display = document.querySelector(`[data-student="${student}"][data-category="${categoryId}"].points-display`);
            let currentValue = parseFloat(display.textContent);
            
            // Pour la colonne attitude, le clic droit ajoute des points positifs
            if (categoryId === 'attitude' && category.valueAlt) {
                currentValue += category.valueAlt;
            } else {
                // Pour les autres colonnes, le clic droit annule le dernier ajout
                currentValue -= category.value;
            }
            
            display.textContent = currentValue.toFixed(2);
            
            updateTotal(student);
            debounceSave();
            showSaveIndicator();
            
            return false;
        }

        function updateTotal(student) {
            let total = 10;
            
            categories.forEach(cat => {
                const display = document.querySelector(`[data-student="${student}"][data-category="${cat.id}"].points-display`);
                const value = parseFloat(display.textContent);
                total += value;
            });
            
            total = Math.max(0, Math.min(20, total));
            
            const totalCell = document.querySelector(`.total-cell[data-student="${student}"]`);
            totalCell.textContent = total.toFixed(2);
            
            totalCell.className = 'total-cell';
            if (total >= 18) totalCell.classList.add('excellent');
            else if (total >= 14) totalCell.classList.add('good');
            else if (total >= 10) totalCell.classList.add('warning');
            else totalCell.classList.add('danger');
        }

        function debounceSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveCurrentData();
            }, 1000);
        }

        async function saveCurrentData() {
            if (!currentClass || students.length === 0) return;
            
            const weekKey = getCurrentWeekKey();
            const data = {};
            
            students.forEach(student => {
                data[student] = {};
                categories.forEach(cat => {
                    const display = document.querySelector(`[data-student="${student}"][data-category="${cat.id}"].points-display`);
                    data[student][cat.id] = parseFloat(display.textContent);
                });
            });
            
            try {
                await setDoc(doc(db, 'notation', weekKey), {
                    data: data,
                    lastUpdate: new Date().toISOString()
                });
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
            }
        }

        async function loadWeekData() {
            if (!currentClass || students.length === 0) return;
            
            const weekKey = getCurrentWeekKey();
            
            try {
                const docSnap = await getDoc(doc(db, 'notation', weekKey));
                
                if (docSnap.exists()) {
                    const weekData = docSnap.data();
                    const data = weekData.data || {};
                    
                    students.forEach(student => {
                        if (data[student]) {
                            categories.forEach(cat => {
                                const display = document.querySelector(`[data-student="${student}"][data-category="${cat.id}"].points-display`);
                                const value = data[student][cat.id] || 0;
                                display.textContent = value.toFixed(2);
                            });
                            updateTotal(student);
                        }
                    });
                } else {
                    students.forEach(student => {
                        categories.forEach(cat => {
                            const display = document.querySelector(`[data-student="${student}"][data-category="${cat.id}"].points-display`);
                            display.textContent = '0';
                        });
                        updateTotal(student);
                    });
                }
            } catch (error) {
                console.error('Erreur chargement:', error);
            }
        }

        window.openManageModal = function() {
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('manageModal').style.display = 'block';
            
            if (currentClass && students.length > 0) {
                document.getElementById('studentsTextarea').value = students.join('\n');
            }
        }

        window.closeManageModal = function() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('manageModal').style.display = 'none';
        }

        window.addClass = async function() {
            const className = document.getElementById('newClassName').value.trim();
            if (!className) {
                alert('Veuillez entrer un nom de classe');
                return;
            }
            
            if (classes.includes(className)) {
                alert('Cette classe existe d√©j√†');
                return;
            }
            
            classes.push(className);
            
            try {
                await setDoc(doc(db, 'notation', 'classes'), {
                    list: classes
                });
                
                document.getElementById('newClassName').value = '';
                await loadClasses();
                showSaveIndicator();
                alert(`Classe "${className}" ajout√©e avec succ√®s !`);
            } catch (error) {
                console.error('Erreur ajout classe:', error);
                alert('Erreur lors de l\'ajout de la classe');
            }
        }

        window.saveStudents = async function() {
            if (!currentClass) {
                alert('Veuillez d\'abord s√©lectionner une classe');
                return;
            }
            
            const textarea = document.getElementById('studentsTextarea');
            const newStudents = textarea.value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);
            
            if (newStudents.length === 0) {
                alert('Veuillez entrer au moins un √©l√®ve');
                return;
            }
            
            try {
                await setDoc(doc(db, 'notation', `students_${currentClass}`), {
                    list: newStudents
                });
                
                students = newStudents;
                closeManageModal();
                
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                initTable();
                await loadWeekData();
                showSaveIndicator();
                alert('√âl√®ves sauvegard√©s avec succ√®s !');
            } catch (error) {
                console.error('Erreur sauvegarde √©l√®ves:', error);
                alert('Erreur lors de la sauvegarde des √©l√®ves');
            }
        }

        window.exportData = function() {
            if (!currentClass || students.length === 0) {
                alert('Aucune donn√©e √† exporter');
                return;
            }
            
            const week = getWeekDates(currentWeekOffset);
            let csv = `Classe: ${currentClass} - Semaine ${week.weekNum}\n\n`;
            csv += '√âl√®ve;Participation;Interro orale;Travail non fait;Oubli cahier;Attitude;TOTAL/20\n';
            
            students.forEach(student => {
                const row = [student];
                
                categories.forEach(cat => {
                    const display = document.querySelector(`[data-student="${student}"][data-category="${cat.id}"].points-display`);
                    row.push(display.textContent);
                });
                
                const totalCell = document.querySelector(`.total-cell[data-student="${student}"]`);
                row.push(totalCell.textContent);
                
                csv += row.join(';') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `notation_${currentClass.replace(/\s+/g, '_')}_semaine_${week.weekNum}.csv`;
            link.click();
        }

        window.resetWeek = async function() {
            if (!currentClass) return;
            
            const password = prompt('‚ö†Ô∏è ATTENTION : Cette action remettra tous les √©l√®ves √† 10/20.\n\nMot de passe du professeur :');
            
            if (password === null) return;
            
            if (password !== 'Prof2024') {
                alert('‚ùå Mot de passe incorrect');
                return;
            }
            
            if (confirm('√ätes-vous vraiment s√ªr de vouloir r√©initialiser toutes les notes √† 10/20 ? Cette action est irr√©versible.')) {
                const weekKey = getCurrentWeekKey();
                
                try {
                    await deleteDoc(doc(db, 'notation', weekKey));
                    await loadWeekData();
                    showSaveIndicator();
                    alert('‚úì Notes r√©initialis√©es avec succ√®s');
                } catch (error) {
                    console.error('Erreur r√©initialisation:', error);
                    alert('‚ùå Erreur lors de la r√©initialisation');
                }
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        async function init() {
            updateWeekDisplay();
            await loadClasses();
        }

        init();
    </script>
</body>
</html>
                